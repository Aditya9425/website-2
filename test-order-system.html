<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order System - Shagun Saree</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Order System Test</h1>
    
    <div class="test-section">
        <h2>1. Test Supabase Connection</h2>
        <button class="test-button" onclick="testSupabaseConnection()">Test Connection</button>
        <div id="connectionResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Order Insertion</h2>
        <button class="test-button" onclick="testOrderInsertion()">Insert Test Order</button>
        <div id="insertResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Order Retrieval</h2>
        <button class="test-button" onclick="testOrderRetrieval()">Fetch Orders</button>
        <div id="retrievalResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Complete Order Flow</h2>
        <button class="test-button" onclick="testCompleteFlow()">Test Full Flow</button>
        <div id="flowResult" class="result"></div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://jstvadizuzvwhabtfhfs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzdHZhZGl6dXp2d2hhYnRmaGZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjI3NjAsImV4cCI6MjA3MjIzODc2MH0.6btNpJfUh6Fd5PfoivIvu-f31Fj5IXl1vxBLsHz5ISw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function testSupabaseConnection() {
            const resultDiv = document.getElementById('connectionResult');
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '‚úÖ Supabase connection successful!';
                }
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Connection error: ${err.message}`;
            }
        }

        async function testOrderInsertion() {
            const resultDiv = document.getElementById('insertResult');
            try {
                const testOrder = {
                    user_id: 'test-user-' + Date.now(),
                    items: [
                        {
                            id: 'test-product-1',
                            name: 'Test Saree',
                            price: 2500,
                            quantity: 1,
                            image: 'test-image.jpg'
                        }
                    ],
                    total_amount: 2500,
                    shipping_addr: {
                        firstName: 'Test',
                        lastName: 'User',
                        email: 'test@example.com',
                        mobile: '9999999999',
                        addressLine1: 'Test Address',
                        city: 'Test City',
                        state: 'Test State',
                        pincode: '123456'
                    },
                    status: 'confirmed',
                    payment_method: 'razorpay',
                    payment_id: 'pay_test_' + Date.now()
                };

                const { data, error } = await supabase
                    .from('orders')
                    .insert([testOrder])
                    .select()
                    .single();

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Insert failed: ${error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `‚úÖ Order inserted successfully! ID: ${data.id}`;
                }
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Insert error: ${err.message}`;
            }
        }

        async function testOrderRetrieval() {
            const resultDiv = document.getElementById('retrievalResult');
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Retrieval failed: ${error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `‚úÖ Retrieved ${data.length} orders successfully!<br>
                        <details>
                            <summary>View Orders</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>`;
                }
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Retrieval error: ${err.message}`;
            }
        }

        async function testCompleteFlow() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.innerHTML = 'üîÑ Testing complete order flow...';
            
            try {
                // Step 1: Create user session
                const userSession = {
                    id: 'test-user-' + Date.now(),
                    email: 'test@example.com',
                    mobile: '9999999999'
                };
                localStorage.setItem('userSession', JSON.stringify(userSession));
                
                // Step 2: Create test cart
                const testCart = [
                    {
                        id: 'test-product-1',
                        name: 'Test Silk Saree',
                        price: 3500,
                        quantity: 1,
                        image: 'test-silk-saree.jpg',
                        category: 'silk'
                    }
                ];
                localStorage.setItem('cart', JSON.stringify(testCart));
                
                // Step 3: Create delivery address
                const deliveryAddress = {
                    firstName: 'Test',
                    lastName: 'Customer',
                    email: 'test@example.com',
                    mobile: '9999999999',
                    addressLine1: '123 Test Street',
                    addressLine2: 'Test Area',
                    city: 'Test City',
                    state: 'Test State',
                    pincode: '123456'
                };
                localStorage.setItem('deliveryAddress', JSON.stringify(deliveryAddress));
                
                // Step 4: Simulate order processing
                const orderData = {
                    user_id: userSession.id,
                    items: testCart,
                    total_amount: 3500,
                    shipping_addr: deliveryAddress,
                    status: 'confirmed',
                    payment_method: 'razorpay',
                    payment_id: 'pay_test_' + Date.now(),
                    razorpay_order_id: 'order_test_' + Date.now()
                };
                
                // Step 5: Insert order
                const { data, error } = await supabase
                    .from('orders')
                    .insert([orderData])
                    .select()
                    .single();
                
                if (error) {
                    throw error;
                }
                
                // Step 6: Clear cart
                localStorage.setItem('cart', JSON.stringify([]));
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `‚úÖ Complete order flow test successful!<br>
                    Order ID: ${data.id}<br>
                    Total: ‚Çπ${data.total_amount}<br>
                    Status: ${data.status}<br>
                    Payment Method: ${data.payment_method}`;
                
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Flow test failed: ${err.message}`;
            }
        }

        // Auto-test connection on page load
        window.addEventListener('load', testSupabaseConnection);
    </script>
</body>
</html>