<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Shagun Saree Baran</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="navbar-styles.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <link rel="stylesheet" href="checkout-mobile-optimized.css">
    <link rel="stylesheet" href="checkout-mobile-final.css">
    <link rel="stylesheet" href="checkout-steps-mobile.css">
    <link rel="stylesheet" href="footer-mobile.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html" class="logo-container">
                    <div class="logo-icon">S</div>
                    <span class="logo-text">Shagun Saree</span>
                </a>
            </div>
            <div class="nav-links" id="navLinks">
                <a href="index.html" class="nav-link">Home</a>
                <a href="collections.html?category=silk" class="nav-link">Silk Sarees</a>
                <a href="collections.html?category=cotton" class="nav-link">Cotton Sarees</a>
                <a href="collections.html?category=bridal" class="nav-link">Wedding Sarees</a>
                <a href="collections.html?category=designer" class="nav-link">Designer Sarees</a>
            </div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="nav-actions">
                <a href="cart.html" class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </a>
                <div id="loginLink" class="login-link">
                    <button class="login-btn" onclick="window.location.href='auth.html'">Login</button>
                </div>
                <div id="profileLink" class="profile-link" style="display: none;">
                    <div class="user-container">
                        <i class="fas fa-user"></i>
                        <span id="userName">User</span>
                    </div>
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <a href="profile.html" class="profile-link">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                        <button id="signOutBtn" class="sign-out-btn" onclick="logout()">Sign Out</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="checkout-main">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="index.html">Home</a> / 
                <a href="cart.html">Cart</a> / 
                <a href="address.html">Address</a> / 
                <span>Checkout</span>
            </nav>

            <!-- Page Header -->
            <div class="page-header">
                <h1>Checkout</h1>
                <p>Complete your purchase securely</p>
            </div>

            <div class="checkout-content">
                <!-- Checkout Steps -->
                <div class="checkout-steps" onclick="scrollToPayNow()" style="cursor: pointer;">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-info">
                            <span class="step-title">Cart</span>
                            <span class="step-desc">Review Items</span>
                        </div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-info">
                            <span class="step-title">Address</span>
                            <span class="step-desc">Delivery Details</span>
                        </div>
                    </div>
                    <div class="step active">
                        <div class="step-number">3</div>
                        <div class="step-info">
                            <span class="step-title">Payment</span>
                            <span class="step-desc">Choose Method</span>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-info">
                            <span class="step-title">Confirmation</span>
                            <span class="step-desc">Order Complete</span>
                        </div>
                    </div>
                </div>

                <!-- Checkout Forms -->
                <div class="checkout-forms">
                    <!-- Payment Method Section -->
                    <section class="payment-method-section">
                        <div class="form-card">
                            <h2>Secure Payment</h2>
                            <div class="razorpay-info">
                                <div class="payment-gateway">
                                    <img src="https://razorpay.com/assets/razorpay-logo.svg" alt="Razorpay" style="height: 40px; margin-bottom: 15px;">
                                    <h3>Pay Securely with Razorpay</h3>
                                    <p>We accept all major payment methods including:</p>
                                    <div class="payment-options">
                                        <span class="payment-badge"><i class="fas fa-credit-card"></i> Cards</span>
                                        <span class="payment-badge"><i class="fas fa-mobile-alt"></i> UPI</span>
                                        <span class="payment-badge"><i class="fas fa-university"></i> Net Banking</span>
                                        <span class="payment-badge"><i class="fas fa-wallet"></i> Wallets</span>
                                    </div>
                                    <div class="security-info">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>256-bit SSL encrypted & PCI DSS compliant</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Delivery Address Display -->
                    <section class="delivery-address-section">
                        <div class="form-card">
                            <h2>Delivery Address</h2>
                            <div id="addressDisplay" class="address-display">
                                <!-- Address will be loaded dynamically -->
                                <p>Loading address...</p>
                            </div>
                            <div class="address-actions">
                                <a href="address.html" class="btn-secondary">
                                    <i class="fas fa-edit"></i>
                                    Edit Address
                                </a>
                            </div>
                        </div>
                    </section>

                    <!-- Order Summary Section -->
                    <section class="order-summary-section">
                        <div class="form-card">
                            <h2>Order Summary</h2>
                            <div id="orderItems" class="order-items">
                                <!-- Order items will be loaded dynamically -->
                            </div>
                            <div class="order-totals">
                                <div class="total-row">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">‚Çπ0</span>
                                </div>
                                <div class="total-row">
                                    <span>Delivery Charges:</span>
                                    <span id="deliveryCharges">‚Çπ0</span>
                                </div>
                                <div class="total-row total-final">
                                    <span>Total:</span>
                                    <span id="total">‚Çπ0</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Pay Now Section -->
                    <section class="pay-now-section">
                        <div class="form-card">
                            <div class="pay-now-content">
                                <button class="pay-now-btn place-order-btn" id="payNowBtn">
                                    <i class="fas fa-credit-card"></i>
                                    Pay Now with Razorpay
                                </button>
                                <div class="secure-info">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>100% Secure Payment</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Security Features -->
            <section class="security-features">
                <div class="security-grid">
                    <div class="security-item">
                        <i class="fas fa-shield-alt"></i>
                        <h4>Secure Payment</h4>
                        <p>256-bit SSL encryption</p>
                    </div>

                    <div class="security-item">
                        <i class="fas fa-undo"></i>
                        <h4>Easy Returns</h4>
                        <p>7 days return policy</p>
                    </div>
                    <div class="security-item">
                        <i class="fas fa-headset"></i>
                        <h4>24/7 Support</h4>
                        <p>Always here to help</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: #2c3e50; color: white; padding: 40px 0 20px;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                <div>
                    <h3 style="color: #FF6B6B; margin-bottom: 15px; font-size: 1.5rem;">Shagun Saree Baran</h3>
                    <p style="color: #ecf0f1; line-height: 1.6; margin: 0;">Your trusted destination for premium Indian sarees. Quality, tradition, and elegance in every piece.</p>
                </div>
                <div>
                    <h4 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">Quick Links</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <a href="index.html" style="color: #ecf0f1; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#FF6B6B'" onmouseout="this.style.color='#ecf0f1'">Home</a>
                        <a href="collections.html" style="color: #ecf0f1; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#FF6B6B'" onmouseout="this.style.color='#ecf0f1'">Collections</a>
                        <a href="cart.html" style="color: #ecf0f1; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#FF6B6B'" onmouseout="this.style.color='#ecf0f1'">Cart</a>
                        <a href="contact.html" style="color: #ecf0f1; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#FF6B6B'" onmouseout="this.style.color='#ecf0f1'">Contact Us</a>
                    </div>
                </div>
                <div>
                    <h4 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">Contact Info</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="color: #ecf0f1;"><i class="fas fa-envelope" style="color: #FF6B6B; margin-right: 8px;"></i>shagunsaree60@gmail.com</div>
                        <div style="color: #ecf0f1;"><i class="fas fa-phone" style="color: #FF6B6B; margin-right: 8px;"></i>+91 9636788945</div>
                        <div style="color: #ecf0f1;"><i class="fas fa-map-marker-alt" style="color: #FF6B6B; margin-right: 8px;"></i>Krishna Colony, Baran, Rajasthan</div>
                    </div>
                </div>
                <div>
                    <h4 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">Follow Us</h4>
                    <div style="display: flex; gap: 15px;">
                        <a href="https://www.instagram.com/shagun_sareebaran?igsh=cjJoZXozejhhZ2Nh" target="_blank" style="color: #ecf0f1; font-size: 1.5rem; transition: color 0.3s;" onmouseover="this.style.color='#e4405f'" onmouseout="this.style.color='#ecf0f1'"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <!-- Feedback Section -->
            <div style="text-align: center; padding: 25px 0; border-top: 1px solid #34495e; margin-bottom: 20px;">
                <p style="color: #bdc3c7; font-size: 14px; margin: 0 0 15px 0; line-height: 1.5;">
                    The website is in early stages. There may be minor bugs. We appreciate your feedback to help us improve!
                </p>
                <button onclick="openFeedbackModal()" style="
                    background: linear-gradient(135deg, #FF6B6B 0%, #E85A4F 100%);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                " onmouseover="this.style.background='linear-gradient(135deg, #E85A4F 0%, #D44638 100%)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='linear-gradient(135deg, #FF6B6B 0%, #E85A4F 100%)'; this.style.transform='translateY(0)';">
                    <i class="fas fa-comment-dots" style="font-size: 16px;"></i>
                    Give Feedback
                </button>
            </div>
            
            <div style="border-top: 1px solid #34495e; padding-top: 20px; text-align: center;">
                <p style="color: #bdc3c7; margin: 0;">&copy; 2025 Shagun Saree Baran. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Order Confirmation Modal -->
    <div class="modal-overlay" id="orderConfirmationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; text-align: center;">
            <div class="modal-header">
                <h2>Order Confirmed!</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Thank you for your order!</h3>
                <p>Your order has been successfully placed. You will receive a confirmation email shortly.</p>
                <div class="order-details">
                    <div class="order-number">
                        <strong>Order Number:</strong>
                        <span id="orderNumber">#SSB2024001</span>
                    </div>
                    <div class="order-total">
                        <strong>Total Amount:</strong>
                        <span id="orderTotal">‚Çπ0</span>
                    </div>
                </div>
                <div class="next-steps">
                    <h4>What's Next?</h4>
                    <ul>
                        <li>You'll receive an order confirmation email</li>
                        <li>We'll notify you when your order ships</li>
                        <li>Track your order in real-time</li>
                        <li>Expected delivery: 3-5 business days</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <a href="index.html" class="btn-primary">
                    <i class="fas fa-shopping-bag"></i>
                    Continue Shopping
                </a>
                <button class="btn-secondary" id="viewOrderBtn">
                    <i class="fas fa-receipt"></i>
                    View Order Details
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="feedback-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Your Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <textarea 
                        id="feedbackText" 
                        placeholder="Please share your thoughts, suggestions, or report any bugs you've encountered. Your feedback helps us improve!"
                        required
                    ></textarea>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-paper-plane"></i>
                        Submit Feedback
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="stock-manager.js"></script>
    <script src="realtime-stock.js"></script>
    <script src="main.js"></script>
    <script src="force-admin-refresh.js"></script>
    <script src="razorpay-frontend.js"></script>
    <script src="payment-integration.js"></script>
    
    <!-- Inline Payment Manager Fallback -->
    <script>
        // Simple payment manager if external file fails
        if (typeof paymentManager === 'undefined') {
            window.paymentManager = {
                async initiatePayment(orderData) {
                    try {
                        // Create order
                        const backendUrl = window.CONFIG ? window.CONFIG.getBackendUrl() : 'http://localhost:5000';
                        const response = await fetch(`${backendUrl}/api/create-order`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                amount: orderData.amount,
                                currency: 'INR',
                                receipt: `order_${Date.now()}`
                            })
                        });
                        
                        const orderResponse = await response.json();
                        
                        if (!orderResponse.success) {
                            throw new Error(orderResponse.error);
                        }
                        
                        // Open Razorpay
                        const options = {
                            key: orderResponse.key_id,
                            amount: orderResponse.amount,
                            currency: orderResponse.currency,
                            name: 'Shagun Saree Baran',
                            description: 'Premium Indian Sarees',
                            order_id: orderResponse.order_id,
                            handler: async (response) => {
                                console.log('Razorpay payment successful:', response);
                                
                                try {
                                    // Verify payment
                                    const verifyResponse = await fetch(`${backendUrl}/api/verify-payment`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            razorpay_order_id: response.razorpay_order_id,
                                            razorpay_payment_id: response.razorpay_payment_id,
                                            razorpay_signature: response.razorpay_signature
                                        })
                                    });
                                    
                                    const verifyData = await verifyResponse.json();
                                    
                                    if (verifyData.success) {
                                        console.log('Payment verified successfully');
                                    } else {
                                        console.warn('Payment verification failed, but continuing');
                                    }
                                } catch (error) {
                                    console.error('Payment verification error:', error);
                                }
                                
                                // Use the new payment completion handler
                                handlePaymentCompletion(response.razorpay_payment_id, response.razorpay_order_id);
                            },
                            prefill: {
                                name: orderData.customerDetails.name,
                                email: orderData.customerDetails.email,
                                contact: orderData.customerDetails.mobile
                            },
                            theme: { color: '#FF6B6B' }
                        };
                        
                        const rzp = new Razorpay(options);
                        rzp.open();
                        
                    } catch (error) {
                        alert('‚ùå Payment failed: ' + error.message);
                    }
                }
            };
        }
    </script>
    
    <script>
        // User menu toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const userContainer = document.querySelector('.user-container');
            const userMenu = document.getElementById('userMenu');
            
            if (userContainer && userMenu) {
                userContainer.addEventListener('click', function() {
                    userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userContainer.contains(e.target) && !userMenu.contains(e.target)) {
                        userMenu.style.display = 'none';
                    }
                });
            }
        });
    </script>
    
    <script>

        
        // Enhanced payment completion handler with order insertion
        async function handlePaymentCompletion(paymentId, orderId) {
            console.log('üí≥ Payment completed:', paymentId, orderId);
            
            try {
                // Get order data
                const urlParams = new URLSearchParams(window.location.search);
                const isBuyNow = urlParams.get('buyNow') === 'true';
                
                let orderItems = [];
                let total = 0;
                
                if (isBuyNow) {
                    const buyNowItem = JSON.parse(localStorage.getItem('buyNowItem') || 'null');
                    if (buyNowItem) {
                        orderItems = [buyNowItem];
                        const subtotal = buyNowItem.price * buyNowItem.quantity;
                        const deliveryCharges = 0;
                        total = subtotal + deliveryCharges;
                    }
                } else {
                    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                    orderItems = cart;
                    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const deliveryCharges = 0;
                    total = subtotal + deliveryCharges;
                }
                
                console.log('üì¶ Processing order with items:', orderItems.length, 'Total:', total);
                
                // Process the order and get the actual order_id from database
                if (typeof processOrder === 'function') {
                    console.log('üîÑ Calling processOrder function...');
                    const orderResult = await processOrder(total, 'razorpay', orderItems, isBuyNow, paymentId);
                    if (orderResult && orderResult.id) {
                        console.log('‚úÖ Order processed successfully with ID:', orderResult.id);
                        // Show confirmation with actual database order_id
                        showOrderConfirmationWithId(orderResult.id, total);
                    } else {
                        console.warn('‚ö†Ô∏è processOrder did not return order ID');
                        showSimpleSuccess(paymentId, total);
                    }
                } else {
                    console.warn('‚ö†Ô∏è processOrder function not available');
                    showSimpleSuccess(paymentId, total);
                }
            } catch (error) {
                console.error('‚ùå Error in handlePaymentCompletion:', error);
                showSimpleSuccess(paymentId, total);
            }
        }
        
        // Show order confirmation with actual order_id
        function showOrderConfirmationWithId(orderId, total) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            popup.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <div style="color: #28a745; font-size: 60px; margin-bottom: 20px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 style="color: #333; margin-bottom: 15px;">Order Placed Successfully!</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 16px;">
                        Your order has been placed successfully. Your Order ID is:
                    </p>
                    <div style="
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin: 20px 0;
                        border-left: 4px solid #28a745;
                    ">
                        <strong style="color: #333; font-size: 18px;">${orderId}</strong>
                    </div>
                    <p style="color: #666; margin-bottom: 25px;">
                        Total Amount: <strong>‚Çπ${total.toLocaleString()}</strong>
                    </p>
                    <button onclick="this.parentElement.parentElement.remove(); window.location.href='index.html';" 
                            style="
                                background: #FF6B6B;
                                color: white;
                                border: none;
                                padding: 12px 30px;
                                border-radius: 6px;
                                font-size: 16px;
                                cursor: pointer;
                            ">
                        Continue Shopping
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                    window.location.href = 'index.html';
                }
            }, 10000);
        }
        
        function showSimpleSuccess(paymentId, total) {
            alert(`‚úÖ Payment Successful!\n\nPayment ID: ${paymentId}\nAmount: ‚Çπ${total.toLocaleString()}\n\nThank you for your order!`);
            setTimeout(() => window.location.href = 'index.html', 2000);
        }
        
        // Enhanced Razorpay payment integration
        async function initRazorpayPayment() {
            const urlParams = new URLSearchParams(window.location.search);
            const isBuyNow = urlParams.get('buyNow') === 'true';
            
            const address = JSON.parse(localStorage.getItem('deliveryAddress') || '{}');
            
            if (!address.firstName) {
                alert('Please add delivery address!');
                const addressUrl = isBuyNow ? 'address.html?buyNow=true' : 'address.html';
                window.location.href = addressUrl;
                return;
            }
            
            let total = 0;
            let orderItems = [];
            
            if (isBuyNow) {
                const buyNowItem = JSON.parse(localStorage.getItem('buyNowItem') || 'null');
                if (!buyNowItem) {
                    alert('No item selected for purchase!');
                    window.location.href = 'collections.html';
                    return;
                }
                orderItems = [buyNowItem];
                const subtotal = buyNowItem.price * buyNowItem.quantity;
                const deliveryCharges = 0; // Set to 0 for testing
                total = subtotal + deliveryCharges;
            } else {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                if (cart.length === 0) {
                    alert('Cart is empty!');
                    return;
                }
                orderItems = cart;
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const deliveryCharges = 0; // Set to 0 for testing
                total = subtotal + deliveryCharges;
            }
            
            const customerDetails = {
                name: `${address.firstName} ${address.lastName}`,
                email: address.email,
                mobile: address.mobile
            };
            
            // Prepare order data for new payment manager
            const orderData = {
                amount: total,
                items: orderItems,
                isBuyNow: isBuyNow,
                address: address,
                customerDetails: customerDetails
            };
            
            // Test backend connection first
            try {
                const backendUrl = window.CONFIG ? window.CONFIG.getBackendUrl() : 'http://localhost:5000';
                const testResponse = await fetch(`${backendUrl}/health`);
                if (!testResponse.ok) {
                    throw new Error('Backend not responding');
                }
                console.log('‚úÖ Backend connection successful');
            } catch (error) {
                alert('‚ùå Backend server not running! Please start the backend server first.');
                return;
            }
            
            // Use new payment manager
            if (typeof paymentManager !== 'undefined') {
                await paymentManager.initiatePayment(orderData);
            } else {
                alert('Payment system not loaded. Please refresh the page.');
            }
        }
        
        // Scroll to Pay Now button function
        function scrollToPayNow() {
            const payNowBtn = document.getElementById('payNowBtn');
            if (payNowBtn) {
                payNowBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // Debug function for testing
        window.testPaymentSuccess = function() {
            console.log('Testing payment success flow...');
            const testPaymentId = 'pay_test_' + Date.now();
            const testOrderId = 'order_test_' + Date.now();
            handlePaymentCompletion(testPaymentId, testOrderId);
        };
        
        // Modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('orderConfirmationModal');
            const modalClose = document.getElementById('modalClose');
            const viewOrderBtn = document.getElementById('viewOrderBtn');
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            
            // Override pay now button
            const payNowBtn = document.getElementById('payNowBtn');
            if (payNowBtn) {
                payNowBtn.onclick = initRazorpayPayment;
            }
            
            // Test backend connection
            const backendUrl = window.CONFIG ? window.CONFIG.getBackendUrl() : 'http://localhost:5000';
            fetch(`${backendUrl}/health`)
                .then(response => response.json())
                .then(data => console.log('‚úÖ Backend connected:', data.message))
                .catch(error => {
                    console.error('‚ùå Backend connection failed:', error);
                    const payBtn = document.getElementById('payNowBtn');
                    if (payBtn) {
                        payBtn.innerHTML = '‚ö†Ô∏è Backend Not Connected';
                        payBtn.disabled = true;
                    }
                });
            
            // Check if this is a buy now flow and update page accordingly
            const urlParams = new URLSearchParams(window.location.search);
            const isBuyNow = urlParams.get('buyNow') === 'true';
            
            if (isBuyNow) {
                // Update page title for buy now
                document.title = 'Buy Now - Shagun Saree Baran';
                const pageHeader = document.querySelector('.page-header h1');
                if (pageHeader) {
                    pageHeader.textContent = 'Buy Now';
                }
            }
            
            // Load checkout data
            loadCheckoutData();
            
            // Close modal
            if (modalClose) {
                modalClose.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // View order details
            if (viewOrderBtn) {
                viewOrderBtn.addEventListener('click', function() {
                    alert('Order details page would open here in production');
                });
            }
        });
        

    </script>
</body>
</html>
