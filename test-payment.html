<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Razorpay Payment - Shagun Saree</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #FF6B6B;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .test-btn {
            background: #FF6B6B;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        .test-btn:hover {
            background: #e55555;
        }
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-cards {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .test-cards h3 {
            margin-top: 0;
            color: #495057;
        }
        .card-info {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 3px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Razorpay Payment</h1>
        
        <form id="testForm">
            <div class="form-group">
                <label for="amount">Amount (‚Çπ)</label>
                <input type="number" id="amount" value="1500" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="customerName">Customer Name</label>
                <input type="text" id="customerName" value="Test Customer" required>
            </div>
            
            <div class="form-group">
                <label for="customerEmail">Customer Email</label>
                <input type="email" id="customerEmail" value="test@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="customerMobile">Customer Mobile</label>
                <input type="tel" id="customerMobile" value="9999999999" required>
            </div>
            
            <button type="submit" class="test-btn" id="payBtn">
                üí≥ Test Payment
            </button>
        </form>
        
        <div id="status" class="status"></div>
        
        <div class="test-cards">
            <h3>üÉè Test Card Numbers</h3>
            <div class="card-info">Success: 4111 1111 1111 1111</div>
            <div class="card-info">Failure: 4000 0000 0000 0002</div>
            <div class="card-info">CVV: Any 3 digits</div>
            <div class="card-info">Expiry: Any future date</div>
        </div>
    </div>

    <script>
        class PaymentTester {
            constructor() {
                this.backendUrl = 'http://localhost:5000';
                this.isProcessing = false;
            }

            async testPayment(formData) {
                if (this.isProcessing) return;

                try {
                    this.isProcessing = true;
                    this.updateButton('processing');
                    this.hideStatus();

                    // Create order
                    const orderResponse = await this.createOrder(formData.amount);
                    
                    if (!orderResponse.success) {
                        throw new Error(orderResponse.error);
                    }

                    // Open Razorpay
                    this.openRazorpay(orderResponse, formData);

                } catch (error) {
                    this.showStatus('Error: ' + error.message, 'error');
                    this.updateButton('default');
                } finally {
                    this.isProcessing = false;
                }
            }

            async createOrder(amount) {
                const response = await fetch(`${this.backendUrl}/api/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        currency: 'INR',
                        receipt: `test_${Date.now()}`
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                return await response.json();
            }

            openRazorpay(orderResponse, formData) {
                const options = {
                    key: orderResponse.key_id,
                    amount: orderResponse.amount,
                    currency: orderResponse.currency,
                    name: 'Shagun Saree Baran',
                    description: 'Test Payment',
                    order_id: orderResponse.order_id,
                    handler: (response) => this.handleSuccess(response),
                    prefill: {
                        name: formData.name,
                        email: formData.email,
                        contact: formData.mobile
                    },
                    theme: {
                        color: '#FF6B6B'
                    },
                    modal: {
                        ondismiss: () => this.handleCancel()
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();
            }

            async handleSuccess(response) {
                try {
                    // Verify payment
                    const verifyResponse = await fetch(`${this.backendUrl}/api/verify-payment`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    });

                    const verifyData = await verifyResponse.json();

                    if (verifyData.success) {
                        this.showStatus(
                            `‚úÖ Payment Successful!<br>
                            Payment ID: ${response.razorpay_payment_id}<br>
                            Order ID: ${response.razorpay_order_id}`,
                            'success'
                        );
                    } else {
                        this.showStatus('‚ùå Payment verification failed', 'error');
                    }

                } catch (error) {
                    this.showStatus('‚ùå Verification error: ' + error.message, 'error');
                } finally {
                    this.updateButton('default');
                }
            }

            handleCancel() {
                this.showStatus('‚ö†Ô∏è Payment cancelled by user', 'error');
                this.updateButton('default');
            }

            updateButton(state) {
                const btn = document.getElementById('payBtn');
                if (state === 'processing') {
                    btn.disabled = true;
                    btn.innerHTML = '‚è≥ Processing...';
                } else {
                    btn.disabled = false;
                    btn.innerHTML = 'üí≥ Test Payment';
                }
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.innerHTML = message;
                status.className = `status ${type}`;
                status.style.display = 'block';
            }

            hideStatus() {
                document.getElementById('status').style.display = 'none';
            }
        }

        // Initialize tester
        const tester = new PaymentTester();

        // Form submission
        document.getElementById('testForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                amount: parseInt(document.getElementById('amount').value),
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                mobile: document.getElementById('customerMobile').value
            };

            tester.testPayment(formData);
        });

        // Check backend connection on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('http://localhost:5000/health');
                if (response.ok) {
                    console.log('‚úÖ Backend connected successfully');
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    '‚ö†Ô∏è Backend not running. Please start the backend server first.';
                document.getElementById('status').className = 'status error';
                document.getElementById('status').style.display = 'block';
                document.getElementById('payBtn').disabled = true;
            }
        });
    </script>
</body>
</html>